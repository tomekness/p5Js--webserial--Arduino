<!DOCTYPE html>
<html>
  <head>
    <title>WebSerial Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/processing.js/1.6.0/processing.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      h1 {
        font-size: 2em;
        margin-top: 0;
      }
      canvas {
        border: 1px solid #333;
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <h1>WebSerial Example</h1>
    <p>Open the console to see output.</p>
    <canvas data-processing-sources="sketch.pde"></canvas>
    <script>
      // Define variables
      let port;
      const valuesUrl = 'values.json';
      let values;
      let index = 0;
      const sendInterval = 1000; // milliseconds
      let lastSendTime = 0;

      // Request permission to access the serial port
      async function requestPort() {
        const filters = [{ usbVendorId: 0x2341 }];
        port = await navigator.serial.requestPort({ filters });
        console.log('Serial port:', port);
        port.addEventListener('open', () => {
          console.log('Serial port opened.');
        });
        port.addEventListener('error', (event) => {
          console.error('Serial port error:', event.error);
        });
        await port.open({ baudRate: 9600 });
      }

      // Load the values from the JSON file
      async function loadValues() {
        const response = await fetch(valuesUrl);
        const data = await response.json();
        values = data.values;
        console.log('Values:', values);
      }

      // Send values over serial at a fixed interval
      function draw() {
        const now = Date.now();
        const elapsedTime = now - lastSendTime;
        if (elapsedTime >= sendInterval) {
          const value = values[index % values.length];
          port.write(new Uint8Array([value]));
          index++;
          lastSendTime = now;
        }
        requestAnimationFrame(draw);
      }

      // Entry point
      async function setup() {
        await requestPort();
        await loadValues();
        lastSendTime = Date.now();
        requestAnimationFrame(draw);
      }

      // Start the sketch when the page is loaded
      window.addEventListener('load', setup);
    </script>
  </body>
</html>
